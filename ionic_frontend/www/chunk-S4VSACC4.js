import{a as ce}from"./chunk-NQ5R2RLE.js";import{a as re,c as ae}from"./chunk-XOXIFAI4.js";import"./chunk-FG76RZX6.js";import{$ as L,$a as B,A as p,C as l,D as r,E as o,F as C,G as P,H as T,Ha as D,J as I,K as x,L as d,T as a,U as g,V as k,_ as M,_a as N,ab as q,bb as H,ca as O,cb as $,da as R,db as J,eb as K,fa as U,fb as Q,ga as V,gb as W,hb as X,ib as Y,l as f,la as j,m as v,ma as F,nb as Z,oa as z,ob as ee,qb as te,rb as ie,sb as ne,t as G,u as c,ub as oe,v as u,x as A}from"./chunk-ABGFETKJ.js";import"./chunk-7DWWQGY5.js";import"./chunk-RUV3JLHO.js";import"./chunk-4QCDUIMV.js";import"./chunk-PZSC2JZC.js";import"./chunk-HC6MZPB3.js";import"./chunk-RWUDUHQX.js";import"./chunk-OYGTIZD7.js";import"./chunk-3H72FJST.js";import"./chunk-LDMQELEG.js";import"./chunk-LEIMCQKJ.js";import"./chunk-ZOGHNDC5.js";import"./chunk-57V45CII.js";import"./chunk-RTD7OIC3.js";import"./chunk-5OMUW5VI.js";import"./chunk-OBXDPQ3V.js";import"./chunk-FQYCRHA2.js";import"./chunk-MCRJI3T3.js";import"./chunk-MJBR6MFX.js";import"./chunk-DPWJJFUE.js";import"./chunk-LZRXIYDK.js";import"./chunk-AYPA7D57.js";import"./chunk-NH7O73XC.js";import"./chunk-LYYJ2XOB.js";import"./chunk-4U6PRYVA.js";import"./chunk-U6SBTS4X.js";import"./chunk-JWIEPCRG.js";import"./chunk-C5RQ2IC2.js";import"./chunk-D4VGNZLR.js";import"./chunk-JHLW7V75.js";import"./chunk-SV7S5NYR.js";import{f as h}from"./chunk-RW4GY4BD.js";function me(t,s){t&1&&(P(0),r(1,"p",6),a(2,"Nessun punteggio disponibile."),o(),T())}function de(t,s){if(t&1&&(r(0,"ion-row")(1,"ion-col",8),a(2),o(),r(3,"ion-col",8),a(4),o(),r(5,"ion-col",8),a(6),M(7,"date"),o()()),t&2){let e=s.$implicit;c(2),g(e.username),c(2),g(e.score),c(2),g(L(7,3,e.created_at,"medium"))}}function ue(t,s){if(t&1&&(r(0,"ion-grid")(1,"ion-row",7)(2,"ion-col",8)(3,"strong"),a(4,"Utente"),o()(),r(5,"ion-col",8)(6,"strong"),a(7,"Punteggio"),o()(),r(8,"ion-col",8)(9,"strong"),a(10,"Data"),o()()(),p(11,de,8,6,"ion-row",9),o()),t&2){let e=d(2);c(11),l("ngForOf",e.scores)}}function ge(t,s){if(t&1){let e=I();r(0,"ion-button",10),x("click",function(){f(e);let n=d(2);return v(n.getScores())}),a(1," aggiorna punteggi "),o()}}function pe(t,s){if(t&1){let e=I();r(0,"ion-button",13),x("click",function(){f(e);let n=d(3);return v(n.approveGame())}),a(1," APPROVA "),o()}}function _e(t,s){if(t&1){let e=I();r(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),a(3,"Azioni amministrative"),o()(),r(4,"ion-button",10),x("click",function(){f(e);let n=d(2);return v(n.downloadGameFiles())}),a(5," SCARICA FILE "),o(),p(6,pe,2,0,"ion-button",11),r(7,"ion-button",12),x("click",function(){f(e);let n=d(2);return v(n.deleteGame())}),a(8," ELIMINA "),o()()}if(t&2){let e=d(2);c(6),l("ngIf",!e.game.approvedby)}}function he(t,s){if(t&1&&(r(0,"ion-content")(1,"ion-card")(2,"div",3),C(3,"iframe",4),o()(),r(4,"ion-card")(5,"ion-card-header")(6,"ion-card-subtitle"),a(7),o()(),r(8,"ion-card-content")(9,"p"),a(10),o()()(),r(11,"ion-card")(12,"ion-card-header")(13,"ion-card-title"),a(14,"Top 10"),o()(),r(15,"ion-card-content"),p(16,me,3,0,"ng-container",2)(17,ue,12,1,"ion-grid",2)(18,ge,2,0,"ion-button",5),o()(),p(19,_e,9,1,"ion-card",2),o()),t&2){let e=d();c(3),l("src",e.iframeUrl,G),c(4),k("di ",e.game.author,""),c(3),g(e.game.description),c(6),l("ngIf",(e.scores==null?null:e.scores.length)===0),c(),l("ngIf",e.scores&&e.scores.length>0),c(),l("ngIf",e.scores&&e.scores.length>0),c(),l("ngIf",e.isAdmin)}}function fe(t,s){if(t&1&&(r(0,"ion-content")(1,"ion-text",14),a(2),o()()),t&2){let e=d();c(2),g(e.error)}}var Pe=(()=>{let s=class s{constructor(i,n,m,_,b,se,le){this.route=i,this.gameService=n,this.sanitizer=m,this.authService=_,this.alertController=b,this.router=se,this.menu=le,this.iframeUrl=null,this.error=null,this.isAdmin=!1,this.hasListener=!1,this.handleScoreMessage=S=>{var y;if(!S.data||S.data.type!=="submitScore")return;let{score:w}=S.data;console.log("received score: ",w);let E=(y=this.game)==null?void 0:y.id;E&&typeof w=="number"&&this.gameService.uploadScore(E,w).subscribe(()=>{console.log("punteggio caricato!")})}}ngOnInit(){document.addEventListener("keydown",i=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(i.key)&&i.preventDefault()},{passive:!1,capture:!0}),this.menu.get("menu").then(i=>{i&&(i.type="overlay")}),this.hasListener||(window.addEventListener("message",this.handleScoreMessage),this.hasListener=!0),this.isAdmin=this.authService.hasRole("admin"),this.gameId=this.route.snapshot.paramMap.get("id"),this.gameService.getGameById(this.gameId).subscribe({next:i=>{if(this.game=i.game,!this.game.approvedby&&!this.isAdmin){this.error="Gioco non ancora approvato, torna pi\xF9 tardi",this.iframeUrl=null;return}let n="http://localhost:3000/uploads/"+this.game.name+"/"+this.game.html;this.iframeUrl=this.sanitizer.bypassSecurityTrustResourceUrl(n),this.getScores()},error:i=>{this.error="Errore nel caricamento del gioco",console.error(i)}})}ngOnDestroy(){window.removeEventListener("message",this.handleScoreMessage)}getScores(){return h(this,null,function*(){if(!this.game){console.error("Nessun gioco trovato");return}this.gameService.listScores(this.game.id).subscribe({next:i=>{this.scores=i.scores},error:i=>{console.error("Errore nel caricamento dei punteggi",i)}})})}approveGame(){return h(this,null,function*(){if(!this.game){console.error("Nessun gioco trovato");return}yield(yield this.alertController.create({header:"Approva Gioco",message:"Sei sicuro di voler approvare questo gioco?",buttons:[{text:"Annulla",role:"cancel"},{text:"Approva",handler:()=>{this.gameService.approveGame(this.game.id).subscribe({next:n=>{this.router.navigate(["/home/dashboard"])},error:n=>{console.error("Errore durante l'approvazione del gioco",n)}})}}]})).present()})}downloadGameFiles(){return h(this,null,function*(){if(!this.game){console.error("Nessun gioco trovato");return}yield(yield this.alertController.create({header:"Scarica Gioco",message:"Sei sicuro di voler scaricare i file di questo gioco?",buttons:[{text:"Annulla",role:"cancel"},{text:"Scarica",handler:()=>{this.gameService.downloadGameFiles(this.gameId).subscribe(n=>{var b;let m=window.URL.createObjectURL(n),_=document.createElement("a");_.href=m,_.download=`${(b=this.game)==null?void 0:b.name}.zip`,_.click(),window.URL.revokeObjectURL(m)})}}]})).present()})}deleteGame(){return h(this,null,function*(){if(!this.game){console.error("Nessun gioco trovato");return}yield(yield this.alertController.create({header:"Elimina Gioco",message:"Sei sicuro di voler eliminare questo gioco?",buttons:[{text:"Annulla",role:"cancel"},{text:"Elimina",handler:()=>{this.gameService.deleteGame(this.game.id).subscribe({next:n=>{this.router.navigate(["/home/dashboard"])},error:n=>{console.error("Errore durante l'eliminazione del gioco",n)}})}}]})).present()})}};s.\u0275fac=function(n){return new(n||s)(u(F),u(ce),u(j),u(ae),u(re),u(z),u(oe))},s.\u0275cmp=A({type:s,selectors:[["app-game"]],decls:8,vars:4,consts:[[3,"translucent"],["slot","start"],[4,"ngIf"],[1,"iframe-container"],["tabindex","0","frameborder","0",3,"src"],["class","big-button",3,"click",4,"ngIf"],[2,"padding","20px"],[1,"scoreboard-header"],["size","4"],[4,"ngFor","ngForOf"],[1,"big-button",3,"click"],["class","big-button","color","success",3,"click",4,"ngIf"],["color","danger",1,"big-button",3,"click"],["color","success",1,"big-button",3,"click"],["color","danger"]],template:function(n,m){n&1&&(r(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),C(3,"ion-menu-button"),o(),r(4,"ion-title"),a(5),o()()(),p(6,he,20,7,"ion-content",2)(7,fe,3,1,"ion-content",2)),n&2&&(l("translucent",!0),c(5),g((m.game==null?null:m.game.name)||"Gioco"),c(),l("ngIf",m.game),c(),l("ngIf",m.error))},dependencies:[Q,ee,X,K,N,W,Y,ie,ne,V,O,R,U,D,B,Z,q,$,J,H,te],styles:[".iframe-container[_ngcontent-%COMP%]{position:relative;width:90vw;max-width:70vw;height:85vh;max-height:100vh;margin:0 auto}.iframe-container[_ngcontent-%COMP%]   iframe[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%}.div.toolbar-title[_ngcontent-%COMP%]{text-align:center;margin:0 auto}.big-button[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:20px}"]});let t=s;return t})();export{Pe as GamePage};
